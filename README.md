# 知乎收藏夹静态化 - Tampermonkey 脚本

一个让知乎收藏夹弹窗更好用的油猴脚本，解决动态加载慢、列表跳动的问题。

## 🌙 深色模式设计
- 护眼深色主题（背景 #1a1a1a）
- 6 列网格布局，卡片式设计
- 柔和蓝色强调色（#4a9eff）
- 自定义深色滚动条
- 详细配色方案见 [DARK_MODE.md](DARK_MODE.md)

## ✨ 功能特性

### 1. **极速加载 + 智能缓存**
- ⚡ **瞬间响应**：第二次打开秒显示，无需等待滚动加载
- 🎯 **智能ID缓存**：自动提取并缓存收藏夹ID，支持直接API调用
- 🔄 **后台同步**：UI立即显示，后台自动更新最新状态
- 💾 **持久化存储**：数据保存在 localStorage，跨页面共享

### 2. **直接API调用**
- 🚀 **收藏操作**：绕过DOM，直接调用知乎API，速度更快
- 🔙 **智能回退**：取消收藏使用模拟点击，确保兼容性
- 🔐 **自动认证**：从cookie读取token，无需手动配置

### 3. **网格布局**
- 📊 一行显示 3 个收藏夹（响应式适配不同屏幕）
- 🎨 卡片式设计，悬停高亮
- 🔒 私密收藏夹显示锁图标
- ✅ 已收藏的收藏夹高亮显示

### 4. **搜索功能**
- 🔍 实时过滤收藏夹
- ⚡ 输入即时响应

### 5. **完美兼容**
- ✨ 自动检测"我的收藏"状态（解决知乎自动收藏问题）
- 🔄 后台同步最新收藏状态
- 💯 收藏/取消收藏稳定可靠

## 📦 安装步骤

### 1. 安装 Tampermonkey
如果还没有安装，请先安装浏览器扩展：
- [Chrome/Edge](https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojposomejjihogmfe)
- [Firefox](https://addons.mozilla.org/en-US/firefox/addon/tampermonkey/)

### 2. 安装脚本
1. 点击 Tampermonkey 图标
2. 选择「管理面板」
3. 点击左侧「+」按钮（创建新脚本）
4. 删除默认内容，粘贴 `zhihu-static-favlist.user.js` 的完整代码
5. 按 `Ctrl+S`（或 `Cmd+S`）保存

### 3. 使用
1. 打开知乎任意文章/回答
2. 点击「收藏」按钮
3. **首次使用**：等待 3-10 秒，脚本会自动加载所有收藏夹并提取ID
4. **后续使用**：⚡ **瞬间显示**缓存的网格列表，无需等待！

## 🎯 使用效果

### 原版知乎收藏夹
- ❌ 默认只加载几个，需要滚动才能看到更多
- ❌ 动态加载伴随排序跳动
- ❌ 收藏夹多了难以查找

### 静态化后
- ✅ 一次性加载所有收藏夹
- ✅ 网格布局，一目了然（一行 3 个，清晰舒适）
- ✅ 搜索框快速定位
- ✅ 智能缓存，⚡ 瞬间打开（第二次开始）

## 🔧 技术细节

### 工作原理
```
1. MutationObserver 监听弹窗出现
   ↓
2. 检查缓存（包含ID？）
   ├─ 有完整缓存（含ID）
   │  ├─ ⚡ 立即渲染UI（快速响应）
   │  └─ 🔄 后台加载DOM（更新状态 + 回退支持）
   │
   └─ 无缓存/缺少ID
      ├─ 自动滚动加载所有收藏夹
      ├─ 从React Fiber提取收藏夹ID
      ├─ 保存到localStorage（含ID）
      └─ 渲染静态网格
```

### 关键技术

#### 1. 从React Fiber提取收藏夹ID
```javascript
const fiberKey = Object.keys(item).find(key => key.startsWith('__reactFiber'));
const fiber = item[fiberKey];
const favlistId = fiber.return.memoizedProps.id;  // 获取真实ID
```

#### 2. 直接调用知乎API
```javascript
// 收藏：POST /api/v4/collections/{id}/contents
fetch(`https://www.zhihu.com/api/v4/collections/${favlistId}/contents?content_id=${contentId}&content_type=answer`, {
    method: 'POST',
    headers: {
        'x-xsrftoken': getXsrfToken(),  // 从cookie自动获取
        'x-zse-93': '101_3_3.0'
    }
});
```

#### 3. localStorage 智能缓存
- **Key**: `zhihu_static_favlist_cache`
- **数据**: `[{id, name, count, isPrivate, isCollected}, ...]`
- **版本控制**: 升级时自动清除旧缓存
- **自动同步**: 后台加载完成后更新UI状态

#### 4. 混合策略
- **收藏操作**：直接调用API（快速）
- **取消收藏**：模拟点击原始按钮（绕过加密签名验证）
- **智能回退**：API失败自动降级到模拟点击

## 🎨 自定义配置

### 修改网格列数
编辑脚本中的 CSS：
```css
.static-favlists-grid {
    grid-template-columns: repeat(3, 1fr);  /* 改成你想要的列数 */
}
```

### 修改容器高度
```css
.static-favlists-grid {
    max-height: 500px;  /* 改成你想要的高度 */
}
```

### 清除缓存
两种方式：
1. **脚本内**：点击「刷新列表」按钮
2. **手动清除**：打开浏览器控制台执行
   ```javascript
   localStorage.removeItem('zhihu_static_favlist_cache');
   ```

## 🐛 故障排查

### 问题1：脚本没有生效
- 检查 Tampermonkey 是否启用
- 检查脚本是否启用
- 刷新知乎页面

### 问题2：首次加载很慢
- 正常现象！脚本需要自动滚动加载所有收藏夹
- 40 个收藏夹大约需要 5-10 秒
- 后续使用会秒开（使用缓存）

### 问题3：收藏夹数量不对
- 点击「刷新列表」按钮重新获取
- 或者手动清除缓存（见上方说明）

### 问题4：点击收藏无反应
- 检查浏览器控制台是否有错误
- 可能是知乎页面结构更新，需要调整脚本选择器

## 📝 更新日志

### v2.0.3 (2025-12-01) 🎉
- ✨ **智能状态同步**：后台加载完成后自动更新"我的收藏"状态
- 🔧 新增 `updateRenderedCards()` 方法，解决知乎自动收藏导致的状态不一致
- 📊 完美解决"我的收藏"显示问题

### v2.0.2 (2025-12-01)
- 🔄 **混合策略优化**：收藏用API，取消收藏用模拟点击
- ⚡ 等待DOM加载完成后再执行取消收藏操作
- 🔐 解决知乎加密签名验证问题

### v2.0.1 (2025-12-01)
- 🐛 修复取消收藏API返回405错误
- 🔄 添加DELETE方法支持

### v2.0.0 (2025-12-01) 🚀 重大更新
- 🎯 **从React Fiber自动提取收藏夹ID**：无需手动映射
- ⚡ **直接调用知乎API**：收藏操作快如闪电
- 💾 **智能ID缓存**：第二次打开瞬间显示，真正的秒开
- 🔄 **后台同步机制**：UI立即显示，后台更新状态
- 🚀 **极速体验**：告别滚动等待，缓存加载快10倍+

### v1.3.0 (2025-11-26)
- 🐛 **重要修复**：保留原始 DOM，解决点击收藏按钮无效的问题
- ✨ 隐藏而非删除知乎原始收藏夹列表，确保 API 调用正常
- 🔄 点击后从原始按钮实时读取状态，而非简单翻转
- 📝 添加详细控制台日志，方便调试
- ⏱️ 延长状态同步等待时间（300ms → 500ms）

### v1.2.0 (2025-11-26)
- 🐛 **重要修复**：解决知乎"点击收藏时立即收藏到'我的收藏'"导致的状态不同步问题
- ✨ 实时从原始 DOM 读取最新收藏状态
- 🎯 避免重复收藏到默认收藏夹
- ⏱️ 延长状态同步等待时间（800ms → 1200ms）

### v1.1.1 (2025-11-26)
- 🐛 修复使用缓存时点击收藏按钮无反应的问题
- ✨ 缓存模式下自动提取原始按钮引用
- 🚀 提升缓存加载的兼容性

### v1.1.0 (2025-11-26)
- 🌙 改为深色模式主题
- ✨ 自定义深色滚动条
- 🎨 优化配色方案，更护眼
- 📄 新增 DARK_MODE.md 配色文档

### v1.0.0 (2025-11-26)
- ✅ 自动加载所有收藏夹
- ✅ localStorage 缓存机制
- ✅ 网格布局（6列）
- ✅ 搜索功能
- ✅ 手动刷新按钮
- ✅ 响应式适配

## 🤝 贡献

欢迎提交 Issue 和 PR！

## 📄 许可

MIT License

## ⚠️ 免责声明

本脚本仅用于改善用户体验，不修改知乎的任何数据和业务逻辑。使用本脚本造成的任何问题，作者不承担责任。
